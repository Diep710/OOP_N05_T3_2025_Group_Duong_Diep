<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Phòng trọ</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #F4F7F9; margin: 0; padding: 0; }
        .header { background-color: #1a4d2e; color: white; padding: 1rem 2rem; }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { color: white; font-weight: bold; font-size: 1.5rem; text-decoration: none; }
        .nav-links { list-style: none; display: flex; gap: 20px; padding: 0; }
        .nav-links a { color: white; text-decoration: none; padding: 5px 10px; border-radius: 5px; }
        .nav-links a:hover { background-color: #3e7e5a; }
        .search-bar { padding: 8px; border-radius: 5px; border: none; }
        .main-content, .content-view { padding: 2rem; max-width: 1200px; margin: 0 auto; display: none; }
        .active-view { display: block; }
        .room-details-section { background-color: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; gap: 20px; overflow: hidden; margin-bottom: 2rem; }
        .room-image-container { flex: 1; }
        .room-image { width: 100%; height: auto; display: block; }
        .room-info-container { flex: 1; padding: 2rem; display: flex; flex-direction: column; justify-content: center; }
        .view-button { background-color: #3e7e5a; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .data-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background-color: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 1.5rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #ddd; }
        .data-table th { background-color: #f2f2f2; }
        .action-buttons button { margin-right: 5px; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .edit-btn { background-color: #2196F3; }
        .delete-btn { background-color: #f44336; }
        .book-btn { background-color: #ff9800; }
        .modal { position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 10px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-row { margin-bottom: 15px; }
        .form-row label, .form-row input, .form-row select, .form-row button { display: block; width: 100%; }
        .form-row label { font-weight: bold; margin-bottom: 5px; }
        .form-row input, .form-row select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .form-row button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <header class="header">
        <nav class="navbar">
            <a href="#" class="logo">DiepDuong</a>
            <ul class="nav-links">
                <li><a href="#" data-view="home">Home</a></li>
                <li><a href="#" data-view="khachhang">List khách hàng</a></li>
                <li><a href="#" data-view="phongtro">List phòng trọ</a></li>
                <li><a href="#" data-view="giaodich">List giao dịch</a></li>
            </ul>
            <input type="text" class="search-bar" id="searchKhachHang" placeholder="Tìm kiếm khách hàng...">
        </nav>
    </header>

    <main id="home" class="main-content active-view">
        <section class="room-details-section">
            <div class="room-image-container">
                <img src="https://ecogreen-saigon.vn/uploads/phong-tro-la-loai-hinh-nha-o-pho-bien-gia-re-tien-loi-cho-sinh-vien-va-nguoi-di-lam.png" alt="Phòng trọ đẹp" class="room-image">
            </div>
            <div class="room-info-container">
                <h2>Phòng trọ Quận Hà Đông</h2>
                <p>Nội thất: Giường, Tủ, Bàn, Điều hòa</p>
                <p>Diện tích: 25 m²</p>
                <p>Tình trạng: Còn trống</p>
                <button class="view-button" id="bookNowBtn">ĐẶT PHÒNG</button>
            </div>
        </section>
        
        <section class="data-section">
            <div class="card room-info-card">
                <h3>Thông tin phòng trọ</h3>
                <p><strong>Mã phòng:</strong> PT203</p>
                <p><strong>Địa chỉ cư trú:</strong> 111 Yên Nghĩa</p>
                <p><strong>Nội thất:</strong> Giường, Tủ, Bàn, Điều hòa</p>
                <p><strong>Diện tích:</strong> 25 m²</p>
                <p><strong>Tình trạng:</strong> Đang cho thuê</p>
            </div>
            <div class="card transaction-info-card">
                <h3>Thông tin giao dịch</h3>
                <p><strong>Tên khách thuê:</strong> Nguyễn Văn A</p>
                <p><strong>Thời hạn:</strong> 1 năm</p>
                <p><strong>Ngày giao dịch:</strong> 01/08/2025</p>
                <p><strong>Tổng tiền:</strong> 24.000.000 VND</p>
            </div>
        </section>
    </main>
    
    <div id="khachhang" class="content-view">
        <h2>Danh sách Khách hàng</h2>
        <button id="addKhachHangBtn">Thêm khách hàng</button>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên</th>
                    <th>Tuổi</th>
                    <th>SĐT</th>
                    <th>Địa chỉ</th>
                    <th>Giới tính</th>
                    <th>CCCD</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="khachHangTableBody"></tbody>
        </table>
    </div>

    <div id="phongtro" class="content-view">
        <h2>Danh sách Phòng trọ</h2>
        <button id="addPhongTroBtn">Thêm phòng trọ</button>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Mã phòng</th>
                    <th>Diện tích</th>
                    <th>Địa chỉ cụ thể</th>
                    <th>Nội thất</th>
                    <th>Giá thuê</th>
                    <th>Tình trạng</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="phongTroTableBody"></tbody>
        </table>
    </div>
    
    <div id="giaodich" class="content-view">
        <h2>Danh sách Giao dịch</h2>
        <button id="addGiaoDichBtn">Thêm giao dịch</button>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Mã khách hàng</th>
                    <th>Mã phòng</th>
                    <th>Ngày giao dịch</th>
                    <th>Thời hạn</th>
                    <th>Tổng tiền</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="giaoDichTableBody"></tbody>
        </table>
    </div>
    
    <div id="bookRoomFormModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="bookRoomFormModal">&times;</span>
            <h3 id="bookRoomFormTitle">Đặt phòng</h3>
            <form id="bookRoomForm">
                <div class="form-row"><label for="bookingMaKhach">Mã khách hàng:</label><input type="text" id="bookingMaKhach" required></div>
                <div class="form-row"><label for="bookingMaPhong">Mã phòng:</label><input type="text" id="bookingMaPhong" required></div>
                <div class="form-row"><label for="bookingTenKhach">Tên khách hàng:</label><input type="text" id="bookingTenKhach" required></div>
                <div class="form-row"><label for="bookingSdtKhach">Số điện thoại:</label><input type="text" id="bookingSdtKhach" required></div>
                <div class="form-row"><label for="bookingCccdKhach">CCCD:</label><input type="text" id="bookingCccdKhach" required></div>
                <div class="form-row"><label for="bookingGioiTinhKhach">Giới tính:</label><input type="text" id="bookingGioiTinhKhach"></div>
                <div class="form-row"><label for="bookingDiaChiKhach">Địa chỉ:</label><input type="text" id="bookingDiaChiKhach"></div>
                <div class="form-row"><label for="bookingTuoiKhach">Tuổi:</label><input type="number" id="bookingTuoiKhach"></div>
                <div class="form-row"><label for="bookingGiaThuePhong">Giá thuê:</label><input type="number" id="bookingGiaThuePhong" required></div>
                <div class="form-row"><label for="bookingStartDate">Ngày bắt đầu thuê:</label><input type="date" id="bookingStartDate" required></div>
                <div class="form-row"><label for="bookingDuration">Thời hạn thuê (tháng):</label><input type="number" id="bookingDuration" required></div>
                <button type="submit">Xác nhận đặt phòng</button>
            </form>
        </div>
    </div>
    
    <div id="addRoomFormModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="addRoomFormModal">&times;</span>
            <h3>Thêm phòng trọ mới</h3>
            <form id="addRoomForm">
                <div class="form-row"><label for="newMaPhong">Mã phòng:</label><input type="text" id="newMaPhong" required></div>
                <div class="form-row"><label for="newDienTich">Diện tích (m²):</label><input type="number" id="newDienTich" required></div>
                <div class="form-row"><label for="newDiaChi">Địa chỉ cụ thể:</label><input type="text" id="newDiaChi" required></div>
                <div class="form-row"><label for="newNoiThat">Nội thất:</label><input type="text" id="newNoiThat"></div>
                <div class="form-row"><label for="newGiaThue">Giá thuê:</label><input type="number" id="newGiaThue" required></div>
                <div class="form-row">
                    <label for="newTinhTrang">Tình trạng:</label>
                    <select id="newTinhTrang" required>
                        <option value="Còn trống">Còn trống</option>
                        <option value="Đang cho thuê">Đang cho thuê</option>
                    </select>
                </div>
                <button type="submit">Thêm phòng</button>
            </form>
        </div>
    </div>
    
    <div id="addKhachHangFormModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="addKhachHangFormModal">&times;</span>
            <h3>Thêm khách hàng mới</h3>
            <form id="addKhachHangForm">
                <div class="form-row"><label for="newTenKH">Tên khách hàng:</label><input type="text" id="newTenKH" required></div>
                <div class="form-row"><label for="newTuoiKH">Tuổi:</label><input type="number" id="newTuoiKH"></div>
                <div class="form-row"><label for="newSdtKH">Số điện thoại:</label><input type="text" id="newSdtKH" required></div>
                <div class="form-row"><label for="newDiaChiKH">Địa chỉ:</label><input type="text" id="newDiaChiKH"></div>
                <div class="form-row"><label for="newGioiTinhKH">Giới tính:</label><input type="text" id="newGioiTinhKH"></div>
                <div class="form-row"><label for="newCccdKH">CCCD:</label><input type="text" id="newCccdKH" required></div>
                <button type="submit">Thêm khách hàng</button>
            </form>
        </div>
    </div>

    <div id="editKhachHangModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="editKhachHangModal">&times;</span>
            <h3>Sửa thông tin khách hàng</h3>
            <form id="editKhachHangForm">
                <input type="hidden" id="editKhachHangId">
                <div class="form-row"><label for="editTenKH">Tên khách hàng:</label><input type="text" id="editTenKH" required></div>
                <div class="form-row"><label for="editTuoiKH">Tuổi:</label><input type="number" id="editTuoiKH"></div>
                <div class="form-row"><label for="editSdtKH">Số điện thoại:</label><input type="text" id="editSdtKH" required></div>
                <div class="form-row"><label for="editDiaChiKH">Địa chỉ:</label><input type="text" id="editDiaChiKH"></div>
                <div class="form-row"><label for="editGioiTinhKH">Giới tính:</label><input type="text" id="editGioiTinhKH"></div>
                <div class="form-row"><label for="editCccdKH">CCCD:</label><input type="text" id="editCccdKH" required></div>
                <button type="submit">Lưu thay đổi</button>
            </form>
        </div>
    </div>
    
    <div id="editPhongTroModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="editPhongTroModal">&times;</span>
            <h3>Sửa thông tin phòng trọ</h3>
            <form id="editPhongTroForm">
                <input type="hidden" id="editPhongTroId">
                <div class="form-row"><label for="editMaPhong">Mã phòng:</label><input type="text" id="editMaPhong" required></div>
                <div class="form-row"><label for="editDienTich">Diện tích (m²):</label><input type="number" id="editDienTich" required></div>
                <div class="form-row"><label for="editDiaChi">Địa chỉ cụ thể:</label><input type="text" id="editDiaChi" required></div>
                <div class="form-row"><label for="editNoiThat">Nội thất:</label><input type="text" id="editNoiThat"></div>
                <div class="form-row"><label for="editGiaThue">Giá thuê:</label><input type="number" id="editGiaThue" required></div>
                <div class="form-row">
                    <label for="editTinhTrang">Tình trạng:</label>
                    <select id="editTinhTrang" required>
                        <option value="Còn trống">Còn trống</option>
                        <option value="Đang cho thuê">Đang cho thuê</option>
                    </select>
                </div>
                <button type="submit">Lưu thay đổi</button>
            </form>
        </div>
    </div>

    <div id="editGiaoDichModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="editGiaoDichModal">&times;</span>
            <h3>Sửa thông tin giao dịch</h3>
            <form id="editGiaoDichForm">
                <input type="hidden" id="editGiaoDichId">
                <div class="form-row"><label for="editMaKhachHang">Mã khách hàng:</label><input type="text" id="editMaKhachHang" required></div>
                <div class="form-row"><label for="editMaPhong">Mã phòng:</label><input type="text" id="editMaPhong" required></div>
                <div class="form-row"><label for="editNgayGiaoDich">Ngày giao dịch:</label><input type="date" id="editNgayGiaoDich" required></div>
                <div class="form-row"><label for="editThoiHan">Thời hạn (tháng):</label><input type="number" id="editThoiHan" required></div>
                <button type="submit">Lưu thay đổi</button>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const views = document.querySelectorAll('.main-content, .content-view');
            const navLinks = document.querySelectorAll('.nav-links a');
            const khachHangTableBody = document.getElementById('khachHangTableBody');
            const phongTroTableBody = document.getElementById('phongTroTableBody');
            const giaoDichTableBody = document.getElementById('giaoDichTableBody');
            
            const bookNowBtn = document.getElementById('bookNowBtn');
            const bookRoomFormModal = document.getElementById('bookRoomFormModal');
            const addRoomFormModal = document.getElementById('addRoomFormModal');
            const addKhachHangFormModal = document.getElementById('addKhachHangFormModal');
            const editKhachHangModal = document.getElementById('editKhachHangModal');
            const editPhongTroModal = document.getElementById('editPhongTroModal');
            const editGiaoDichModal = document.getElementById('editGiaoDichModal');
            const searchInput = document.getElementById('searchKhachHang');

            const roomDetailsSection = document.querySelector('.room-details-section');
            const dataSection = document.querySelector('.data-section');
            
            let khachHangs = [
                { id: 1, maKhachHang: 'KH001', ten: 'Nguyễn Văn A', tuoi: 25, sdt: '0987654321', diaChi: '111 Yên Nghĩa', gioiTinh: 'Nam', cccd: '001234567890' },
                { id: 2, maKhachHang: 'KH002', ten: 'Trần Thị B', tuoi: 22, sdt: '0912345678', diaChi: '222 Hà Đông', gioiTinh: 'Nữ', cccd: '001987654321' },
                { id: 3, maKhachHang: 'KH003', ten: 'Lê Văn C', tuoi: 28, sdt: '0901234567', diaChi: '333 Thanh Xuân', gioiTinh: 'Nam', cccd: '001112233445' }
            ];

            let phongTros = [
                { id: 1, maPhong: 'PT001', dienTich: 25, diaChiCuThe: '111 Yên Nghĩa', noiThat: 'Giường, Tủ, Bàn', giaThue: 2500000, tinhTrang: 'Đang cho thuê' },
                { id: 2, maPhong: 'PT002', dienTich: 30, diaChiCuThe: '222 Hà Đông', noiThat: 'Giường, Tủ, Điều hòa', giaThue: 3000000, tinhTrang: 'Còn trống' },
                { id: 3, maPhong: 'PT003', dienTich: 20, diaChiCuThe: '444 Cầu Giấy', noiThat: 'Giường, Tủ', giaThue: 2000000, tinhTrang: 'Còn trống' }
            ];
            
            let giaoDichs = [
                { id: 1, maKhachHang: 'KH001', maPhong: 'PT001', ngayGiaoDich: '2023-01-15', thoiHan: '12 tháng', tongTien: 5000000 },
                { id: 2, maKhachHang: 'KH002', maPhong: 'PT002', ngayGiaoDich: '2023-02-20', thoiHan: '6 tháng', tongTien: 6000000 }
            ];

            const renderView = (viewId) => {
                views.forEach(view => {
                    view.classList.remove('active-view');
                    if (view.id === viewId) {
                        view.classList.add('active-view');
                    }
                });
            };

            const renderKhachHangs = (filteredKhachHangs = khachHangs) => {
                khachHangTableBody.innerHTML = '';
                filteredKhachHangs.forEach(khach => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${khach.id}</td><td>${khach.ten}</td><td>${khach.tuoi || 'N/A'}</td><td>${khach.sdt}</td><td>${khach.diaChi || 'N/A'}</td><td>${khach.gioiTinh || 'N/A'}</td><td>${khach.cccd}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-id="${khach.id}" data-type="khachhang">Sửa</button>
                            <button class="delete-btn" data-id="${khach.id}" data-type="khachhang">Xóa</button>
                        </td>
                    `;
                    khachHangTableBody.appendChild(row);
                });
            };

            const renderPhongTros = () => {
                phongTroTableBody.innerHTML = '';
                phongTros.forEach(phong => {
                    const row = document.createElement('tr');
                    const bookBtnHtml = (phong.tinhTrang === 'Còn trống') 
                        ? `<button class="book-btn" data-ma-phong="${phong.maPhong}">Đặt phòng</button>` 
                        : '';
                    row.innerHTML = `
                        <td>${phong.id}</td><td>${phong.maPhong}</td><td>${phong.dienTich} m²</td><td>${phong.diaChiCuThe}</td><td>${phong.noiThat}</td><td>${phong.giaThue.toLocaleString()} VND</td><td>${phong.tinhTrang}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-id="${phong.id}" data-type="phongtro">Sửa</button>
                            <button class="delete-btn" data-id="${phong.id}" data-type="phongtro">Xóa</button>
                            ${bookBtnHtml}
                        </td>
                    `;
                    phongTroTableBody.appendChild(row);
                });
            };
            
            const renderGiaoDichs = () => {
                giaoDichTableBody.innerHTML = '';
                giaoDichs.forEach(giaoDich => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${giaoDich.id}</td><td>${giaoDich.maKhachHang}</td><td>${giaoDich.maPhong}</td><td>${giaoDich.ngayGiaoDich}</td><td>${giaoDich.thoiHan}</td><td>${giaoDich.tongTien.toLocaleString()} VND</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-id="${giaoDich.id}" data-type="giaodich">Sửa</button>
                            <button class="delete-btn" data-id="${giaoDich.id}" data-type="giaodich">Xóa</button>
                        </td>
                    `;
                    giaoDichTableBody.appendChild(row);
                });
            };

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.target.dataset.view;
                    if (viewId) {
                        renderView(viewId);
                        if (viewId === 'khachhang') renderKhachHangs();
                        if (viewId === 'phongtro') renderPhongTros();
                        if (viewId === 'giaodich') renderGiaoDichs();
                    }
                });
            });

            // Thanh tìm kiếm khách hàng
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredKhachHangs = khachHangs.filter(khach =>
                    khach.ten.toLowerCase().includes(searchTerm) ||
                    khach.sdt.toLowerCase().includes(searchTerm) ||
                    khach.diaChi.toLowerCase().includes(searchTerm) ||
                    khach.cccd.toLowerCase().includes(searchTerm)
                );
                renderView('khachhang');
                renderKhachHangs(filteredKhachHangs);
            });

            // Nút "Đặt phòng" trên trang chủ
            bookNowBtn.addEventListener('click', () => {
                const phongTrong = phongTros.find(phong => phong.tinhTrang === 'Còn trống');
                if (phongTrong) {
                    document.getElementById('bookingMaPhong').value = phongTrong.maPhong;
                    bookRoomFormModal.style.display = 'flex';
                } else {
                    alert('Hiện tại không có phòng trống nào.');
                }
            });

            // Nút "Đặt phòng" trong danh sách phòng trọ
            phongTroTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('book-btn')) {
                    const maPhong = e.target.dataset.maPhong;
                    document.getElementById('bookingMaPhong').value = maPhong;
                    bookRoomFormModal.style.display = 'flex';
                }
            });

            // Xử lý Form đặt phòng từ modal
            document.getElementById('bookRoomForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const maKhach = document.getElementById('bookingMaKhach').value;
                const maPhong = document.getElementById('bookingMaPhong').value;
                const tenKhach = document.getElementById('bookingTenKhach').value;
                const sdtKhach = document.getElementById('bookingSdtKhach').value;
                const cccdKhach = document.getElementById('bookingCccdKhach').value;
                
                const gioiTinhKhach = document.getElementById('bookingGioiTinhKhach').value;
                const diaChiKhach = document.getElementById('bookingDiaChiKhach').value;
                const tuoiKhach = parseInt(document.getElementById('bookingTuoiKhach').value);
                const giaThuePhong = parseInt(document.getElementById('bookingGiaThuePhong').value);

                const ngayBatDau = document.getElementById('bookingStartDate').value;
                const thoiHan = parseInt(document.getElementById('bookingDuration').value);

                const phong = phongTros.find(p => p.maPhong === maPhong);

                if (phong && phong.tinhTrang !== 'Còn trống') {
                    alert('Phòng này đã có người đặt, bạn vui lòng chọn phòng khác.');
                    return;
                }
                
                // Thêm khách hàng mới nếu chưa có
                const existingKhach = khachHangs.find(kh => kh.maKhachHang === maKhach);
                if (!existingKhach) {
                    const newKhachHang = {
                        id: khachHangs.length > 0 ? Math.max(...khachHangs.map(kh => kh.id)) + 1 : 1,
                        maKhachHang: maKhach,
                        ten: tenKhach,
                        sdt: sdtKhach,
                        cccd: cccdKhach,
                        tuoi: tuoiKhach,
                        diaChi: diaChiKhach,
                        gioiTinh: gioiTinhKhach
                    };
                    khachHangs.push(newKhachHang);
                }

                let phongSauDat;
                // Xử lý khi mã phòng chưa tồn tại (đặt phòng mới hoàn toàn)
                if (!phong) {
                    const newPhong = {
                        id: phongTros.length > 0 ? Math.max(...phongTros.map(p => p.id)) + 1 : 1,
                        maPhong: maPhong,
                        dienTich: 0, 
                        diaChiCuThe: 'Đang cập nhật',
                        noiThat: 'Đang cập nhật',
                        giaThue: giaThuePhong,
                        tinhTrang: 'Đang cho thuê'
                    };
                    phongTros.push(newPhong);
                    phongSauDat = newPhong;
                    console.log('Tạo phòng mới thành công:', newPhong);
                } else {
                    phong.tinhTrang = 'Đang cho thuê';
                    phongSauDat = phong;
                }

                const tongTien = phongSauDat ? phongSauDat.giaThue * thoiHan : 0;

                const newGiaoDich = {
                    id: giaoDichs.length > 0 ? Math.max(...giaoDichs.map(gd => gd.id)) + 1 : 1,
                    maKhachHang: maKhach,
                    maPhong: maPhong,
                    ngayGiaoDich: ngayBatDau,
                    thoiHan: `${thoiHan} tháng`,
                    tongTien: tongTien
                };
                giaoDichs.push(newGiaoDich);
                
                alert(`Yêu cầu đặt phòng mã ${maPhong} của khách hàng ${tenKhach} đã được gửi thành công!`);

                bookRoomFormModal.style.display = 'none';
                document.getElementById('bookRoomForm').reset();
                renderPhongTros();
                renderKhachHangs();
                renderGiaoDichs();
            });

            // Mở modal thêm phòng
            document.getElementById('addPhongTroBtn').addEventListener('click', () => {
                addRoomFormModal.style.display = 'flex';
            });
            
            // Xử lý form thêm phòng mới
            document.getElementById('addRoomForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newPhong = {
                    id: phongTros.length > 0 ? Math.max(...phongTros.map(p => p.id)) + 1 : 1,
                    maPhong: document.getElementById('newMaPhong').value,
                    dienTich: parseInt(document.getElementById('newDienTich').value),
                    diaChiCuThe: document.getElementById('newDiaChi').value,
                    noiThat: document.getElementById('newNoiThat').value,
                    giaThue: parseInt(document.getElementById('newGiaThue').value),
                    tinhTrang: document.getElementById('newTinhTrang').value,
                };
                phongTros.push(newPhong);
                addRoomFormModal.style.display = 'none';
                document.getElementById('addRoomForm').reset();
                renderPhongTros();
                alert('Thêm phòng trọ mới thành công!');
            });
            
            // Mở modal thêm khách hàng
            document.getElementById('addKhachHangBtn').addEventListener('click', () => {
                addKhachHangFormModal.style.display = 'flex';
            });

            // Xử lý form thêm khách hàng mới
            document.getElementById('addKhachHangForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newKhachHang = {
                    id: khachHangs.length > 0 ? Math.max(...khachHangs.map(kh => kh.id)) + 1 : 1,
                    ten: document.getElementById('newTenKH').value,
                    tuoi: parseInt(document.getElementById('newTuoiKH').value),
                    sdt: document.getElementById('newSdtKH').value,
                    diaChi: document.getElementById('newDiaChiKH').value,
                    gioiTinh: document.getElementById('newGioiTinhKH').value,
                    cccd: document.getElementById('newCccdKH').value,
                };
                khachHangs.push(newKhachHang);
                addKhachHangFormModal.style.display = 'none';
                document.getElementById('addKhachHangForm').reset();
                renderKhachHangs();
                alert('Thêm khách hàng mới thành công!');
            });

            // Xử lý sự kiện Sửa/Xóa chung
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('edit-btn')) {
                    const id = parseInt(target.dataset.id);
                    const type = target.dataset.type;
                    if (type === 'khachhang') {
                        const khach = khachHangs.find(k => k.id === id);
                        document.getElementById('editKhachHangId').value = khach.id;
                        document.getElementById('editTenKH').value = khach.ten;
                        document.getElementById('editTuoiKH').value = khach.tuoi || '';
                        document.getElementById('editSdtKH').value = khach.sdt;
                        document.getElementById('editDiaChiKH').value = khach.diaChi || '';
                        document.getElementById('editGioiTinhKH').value = khach.gioiTinh || '';
                        document.getElementById('editCccdKH').value = khach.cccd;
                        editKhachHangModal.style.display = 'flex';
                    } else if (type === 'phongtro') {
                        const phong = phongTros.find(p => p.id === id);
                        document.getElementById('editPhongTroId').value = phong.id;
                        document.getElementById('editMaPhong').value = phong.maPhong;
                        document.getElementById('editDienTich').value = phong.dienTich;
                        document.getElementById('editDiaChi').value = phong.diaChiCuThe;
                        document.getElementById('editNoiThat').value = phong.noiThat;
                        document.getElementById('editGiaThue').value = phong.giaThue;
                        document.getElementById('editTinhTrang').value = phong.tinhTrang;
                        editPhongTroModal.style.display = 'flex';
                    } else if (type === 'giaodich') {
                        const giaoDich = giaoDichs.find(gd => gd.id === id);
                        document.getElementById('editGiaoDichId').value = giaoDich.id;
                        document.getElementById('editMaKhachHang').value = giaoDich.maKhachHang;
                        document.getElementById('editMaPhong').value = giaoDich.maPhong;
                        document.getElementById('editNgayGiaoDich').value = giaoDich.ngayGiaoDich;
                        document.getElementById('editThoiHan').value = parseInt(giaoDich.thoiHan);
                        editGiaoDichModal.style.display = 'flex';
                    }
                } else if (target.classList.contains('delete-btn')) {
                    const id = parseInt(target.dataset.id);
                    const type = target.dataset.type;
                    if (confirm(`Bạn có chắc chắn muốn xóa mục này không?`)) {
                        if (type === 'khachhang') {
                            khachHangs = khachHangs.filter(k => k.id !== id);
                            renderKhachHangs();
                        } else if (type === 'phongtro') {
                            phongTros = phongTros.filter(p => p.id !== id);
                            renderPhongTros();
                        } else if (type === 'giaodich') {
                            giaoDichs = giaoDichs.filter(gd => gd.id !== id);
                            renderGiaoDichs();
                        }
                        alert('Đã xóa thành công!');
                    }
                }
            });

            // Xử lý form sửa khách hàng
            document.getElementById('editKhachHangForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editKhachHangId').value);
                const khach = khachHangs.find(k => k.id === id);
                if (khach) {
                    khach.ten = document.getElementById('editTenKH').value;
                    khach.tuoi = parseInt(document.getElementById('editTuoiKH').value);
                    khach.sdt = document.getElementById('editSdtKH').value;
                    khach.diaChi = document.getElementById('editDiaChiKH').value;
                    khach.gioiTinh = document.getElementById('editGioiTinhKH').value;
                    khach.cccd = document.getElementById('editCccdKH').value;
                    alert('Sửa thông tin khách hàng thành công!');
                    editKhachHangModal.style.display = 'none';
                    renderKhachHangs();
                }
            });

            // Xử lý form sửa phòng trọ
            document.getElementById('editPhongTroForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editPhongTroId').value);
                const phong = phongTros.find(p => p.id === id);
                if (phong) {
                    phong.maPhong = document.getElementById('editMaPhong').value;
                    phong.dienTich = parseInt(document.getElementById('editDienTich').value);
                    phong.diaChiCuThe = document.getElementById('editDiaChi').value;
                    phong.noiThat = document.getElementById('editNoiThat').value;
                    phong.giaThue = parseInt(document.getElementById('editGiaThue').value);
                    phong.tinhTrang = document.getElementById('editTinhTrang').value;
                    alert('Sửa thông tin phòng trọ thành công!');
                    editPhongTroModal.style.display = 'none';
                    renderPhongTros();
                }
            });
            
            // Xử lý form sửa giao dịch
            document.getElementById('editGiaoDichForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editGiaoDichId').value);
                const giaoDich = giaoDichs.find(gd => gd.id === id);
                if (giaoDich) {
                    const newThoiHan = parseInt(document.getElementById('editThoiHan').value);
                    const phong = phongTros.find(p => p.maPhong === document.getElementById('editMaPhong').value);
                    const newTongTien = phong ? phong.giaThue * newThoiHan : 0;
                    
                    giaoDich.maKhachHang = document.getElementById('editMaKhachHang').value;
                    giaoDich.maPhong = document.getElementById('editMaPhong').value;
                    giaoDich.ngayGiaoDich = document.getElementById('editNgayGiaoDich').value;
                    giaoDich.thoiHan = `${newThoiHan} tháng`;
                    giaoDich.tongTien = newTongTien;
                    alert('Sửa thông tin giao dịch thành công!');
                    editGiaoDichModal.style.display = 'none';
                    renderGiaoDichs();
                }
            });


            // Đóng các modal
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalId = e.target.dataset.modal;
                    document.getElementById(modalId).style.display = 'none';
                });
            });

            renderView('home');
        });
    </script>
</body>
</html>